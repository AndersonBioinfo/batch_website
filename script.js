// ========================================
// BATCH GENERATOR - Process 100 Samples
// Upload multiple Excel files at once
// ========================================

const PAGE_TEMPLATE = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gene Coverage Report - {{PATIENT_NAME}}</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    .header-wrapper {
      background-color: white;
      position: relative;
      z-index: 2;
      height: 150px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      padding: 0 30px;
    }

    .logo img {
      width: 200px;
      height: auto;
      margin-right: 10px;
    }

    .logotext {
      color: black;
      font-weight: bold;
      font-size: 18px;
    }

    .patient-header {
      background-color: white;
      padding: 10px 30px;
      border-bottom: 2px solid orangered;
    }

    .patient-header h3 {
      margin: 0;
      color: #333;
      font-size: 18px;
    }

    .container {
      text-align: center;
      margin-top: 20px;
    }

    .controls {
      margin: 20px auto;
      max-width: 800px;
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    input[type="text"] {
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-width: 300px;
    }

    button {
      padding: 8px 16px;
      background-color: orangered;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background-color: #cc5500;
    }

    .table-wrapper {
      max-height: 700px;
      overflow-y: auto;
      border: 1px solid #ccc;
      margin: 0 auto;
      width: 60%;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      border: 1px solid #000000;
      padding: 8px;
      font-weight: 100;
      font-size: 14px;
      text-align: center;
    }

    th {
      background-color: orangered;
      color: white;
      position: sticky;
      top: 0;
      cursor: pointer;
    }

    @media only screen and (max-width: 600px) {
      .table-wrapper {
        width: 95%;
      }
      table {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="header-wrapper">
    <div class="logo">
      <img src="data:image/png;base64,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" alt="Logo">
    </div>
    <div class="logotext">
      Gene Coverage Metrics
    </div>
  </div>

  <div class="patient-header">
    <h3>Patient: {{PATIENT_NAME}}</h3>
  </div>

  <div class="container">
    <div class="controls">
      <input type="text" id="searchInput" placeholder="Search by Gene..." />
      <button onclick="sortTable(true)">Sort Ascending</button>
      <button onclick="sortTable(false)">Sort Descending</button>
      <button id="downloadBtn">Download Excel</button>
    </div>

    <div class="table-wrapper">
      <table id="dataTable">
        <thead>
          <tr>
            <th>S.No</th>
            <th>Gene</th>
            <th>Percentage of coding region covered</th>
          </tr>
        </thead>
        <tbody>
          {{TABLE_ROWS}}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const searchInput = document.getElementById('searchInput');
    const tbody = document.querySelector('tbody');
    let rows = Array.from(tbody.querySelectorAll('tr'));

    searchInput.addEventListener('keyup', function(event) {
      const searchText = event.target.value.toLowerCase();
      rows.forEach(row => {
        const cells = Array.from(row.getElementsByTagName('td'));
        const found = cells.some(cell => cell.textContent.toLowerCase().includes(searchText));
        row.style.display = found ? '' : 'none';
      });
    });

    function sortTable(ascending) {
      const sortedRows = rows.slice().sort((a, b) => {
        const aVal = parseFloat(a.cells[2].textContent) || 0;
        const bVal = parseFloat(b.cells[2].textContent) || 0;
        return ascending ? aVal - bVal : bVal - aVal;
      });

      sortedRows.forEach((row, index) => {
        row.cells[0].textContent = index + 1;
        tbody.appendChild(row);
      });
      rows = sortedRows;
    }

    document.getElementById('downloadBtn').addEventListener('click', function() {
      const visibleRows = rows.filter(row => row.style.display !== 'none');
      let csvContent = "S.No,Gene,Percentage\\n";
      visibleRows.forEach(row => {
        const cells = Array.from(row.cells).map(cell => '"' + cell.textContent.trim() + '"');
        csvContent += cells.join(',') + '\\n';
      });
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'gene_coverage_{{PATIENT_NAME}}.csv';
      link.click();
    });
  </script>
</body>
</html>
`;

let processedFiles = [];

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('excelUpload')
    .addEventListener('change', handleBatchExcelUpload);

  document.getElementById('downloadAllHtml')
    .addEventListener('click', handleDownloadAllHtml);
});

// ========================================
// Handle Multiple Excel Files
// ========================================
async function handleBatchExcelUpload(event) {
  const files = event.target.files;

  if (!files || files.length === 0) {
    alert('Please select Excel files.');
    return;
  }

  processedFiles = [];
  const progressDiv = document.getElementById('progress');
  progressDiv.style.display = 'block';

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    const fileName = file.name.replace(/\\.xlsx?$/i, '');

    progressDiv.textContent = `Processing ${i + 1} of ${files.length}: ${fileName}...`;

    await processFile(file, fileName);
  }

  progressDiv.textContent = `✅ Successfully loaded ${processedFiles.length} samples!`;

  setTimeout(() => {
    alert(`Ready to download ${processedFiles.length} HTML reports!`);
  }, 500);
}

function processFile(file, patientName) {
  return new Promise((resolve) => {
    const reader = new FileReader();

    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const samples = XLSX.utils.sheet_to_json(sheet, { defval: '' });

        if (samples.length > 0) {
          processedFiles.push({
            patientName: patientName,
            samples: samples
          });
        }

        resolve();
      } catch (error) {
        console.error(`Error processing ${patientName}:`, error);
        resolve();
      }
    };

    reader.onerror = () => resolve();
    reader.readAsArrayBuffer(file);
  });
}

// ========================================
// Build Rows for One Sample
// ========================================
function buildTableRows(samples) {
  const rows = [];

  for (let idx = 0; idx < samples.length; idx++) {
    const row = samples[idx];
    const sno = idx + 1;
    const gene = row['Gene_Name'] || row['Gene'] || row['gene'] || '';

    let pct1x = row['%_1x'] || row['Coverage'] || row['Percentage'];

    if (pct1x === 0 || pct1x === '0' || pct1x === 0.0) {
      pct1x = '0';
    } else if (!pct1x && pct1x !== 0) {
      pct1x = '';
    } else {
      pct1x = String(pct1x);
    }

    rows.push(`<tr><td>${sno}</td><td>${gene}</td><td>${pct1x}</td></tr>`);
  }

  return rows.join('');
}

function buildFullPage(patientName, samples) {
  const rowsHtml = buildTableRows(samples);
  return PAGE_TEMPLATE
    .replace(/{{PATIENT_NAME}}/g, patientName)
    .replace('{{TABLE_ROWS}}', rowsHtml);
}

// ========================================
// Download All HTML Files as ZIP
// ========================================
async function handleDownloadAllHtml() {
  if (processedFiles.length === 0) {
    alert('Please upload Excel files first.');
    return;
  }

  const progressDiv = document.getElementById('progress');
  progressDiv.textContent = 'Generating HTML files...';

  // Create ZIP file
  const zip = new JSZip();

  for (let i = 0; i < processedFiles.length; i++) {
    const fileData = processedFiles[i];
    const htmlContent = buildFullPage(fileData.patientName, fileData.samples);

    const safeFilename = fileData.patientName.replace(/[^a-z0-9_-]/gi, '_');
    zip.file(`coverage_${safeFilename}.html`, htmlContent);

    progressDiv.textContent = `Creating ${i + 1} of ${processedFiles.length}...`;
  }

  progressDiv.textContent = 'Compressing files...';

  // Generate ZIP
  const blob = await zip.generateAsync({ type: 'blob' });
  saveAs(blob, 'gene_coverage_reports.zip');

  progressDiv.textContent = `✅ Downloaded ${processedFiles.length} reports as ZIP!`;
}
